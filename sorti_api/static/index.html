<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorti SmartBin Dashboard</title>

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.webmanifest">
  <meta name="theme-color" content="#29d391">
  <link rel="apple-touch-icon" href="/static/icon-192.png">

  <style>
    :root{
      --bg1:#07121a;
      --bg2:#061321;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --green:#29d391;
      --blue:#1aa6ff;
      --yellow:#ffcc66;
      --red:#ff5a6b;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--txt);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(41,211,145,.25), transparent 60%),
        radial-gradient(1000px 600px at 80% 0%, rgba(26,166,255,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding: 28px 22px 40px;
    }

    .wrap{max-width: 1280px; margin: 0 auto;}
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:16px; margin-bottom:18px;
    }
    .brand{display:flex; gap:14px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(41,211,145,.95), rgba(26,166,255,.9));
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    h1{margin:0; font-size:28px; line-height:1.1;}
    .subtitle{margin-top:4px; color:var(--muted); font-size:14px;}

    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      border:1px solid var(--stroke); background:rgba(0,0,0,.18);
      color:var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--green);
      box-shadow: 0 0 0 6px rgba(41,211,145,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: 2fr 1.1fr;
      gap:16px;
      margin-top: 14px;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.03));
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin:0 0 12px;
      font-size:16px;
      color: rgba(255,255,255,.88);
      letter-spacing:.2px;
    }
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius: 16px;
      padding: 14px;
      min-height: 108px;
    }
    .kpi .label{color:var(--muted); font-size:13px;}
    .kpi .value{font-size:26px; font-weight:800; margin-top:10px;}
    .kpi .hint{margin-top:8px; font-size:12px; color: rgba(255,255,255,.55);}

    .row2{
      display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;
      color: var(--muted);
      font-size:13px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      padding: 8px 10px;
      display:inline-flex; gap:8px; align-items:center;
    }

    select, input{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      outline:none;
    }
    .btn{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      transition: transform .05s ease, background .15s ease;
      font-weight:600;
    }
    .btn:hover{background: rgba(255,255,255,.12);}
    .btn:active{transform: translateY(1px);}
    .btnPrimary{
      background: linear-gradient(135deg, rgba(41,211,145,.95), rgba(26,166,255,.75));
      border: none;
      color: #052018;
    }

    .actionsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    .actionsGrid .btn{width:100%;}
    .help{margin-top:10px; color: var(--muted); font-size:13px; line-height:1.4;}

    h3{
      margin: 18px 0 10px;
      font-size: 18px;
      letter-spacing:.2px;
    }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing:0 10px;
    }
    thead th{
      text-align:left;
      font-size:13px;
      color: rgba(255,255,255,.55);
      font-weight:600;
      padding: 0 12px;
    }
    tbody tr{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      overflow:hidden;
    }
    tbody td{padding: 12px;}
    tbody tr td:first-child{border-top-left-radius:14px; border-bottom-left-radius:14px;}
    tbody tr td:last-child{border-top-right-radius:14px; border-bottom-right-radius:14px;}

    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight:700;
      border: 1px solid rgba(255,255,255,.10);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .bOk{background: rgba(41,211,145,.14); color: rgba(220,255,242,.95);}
    .bWarn{background: rgba(255,204,102,.14); color: rgba(255,238,210,.95);}
    .bBad{background: rgba(255,90,107,.14); color: rgba(255,220,224,.95);}

    .bar{
      width: 160px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      display:inline-block;
      vertical-align:middle;
      margin-left:10px;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(41,211,145,.95), rgba(26,166,255,.95));
    }

    .insights{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top: 14px;
    }
    .canvasWrap{
      height: 260px;
    }

    @media (max-width: 1100px){
      .grid{grid-template-columns: 1fr;}
      .kpiRow{grid-template-columns: 1fr 1fr;}
      .insights{grid-template-columns: 1fr;}
      .bar{width:120px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Sorti SmartBin Dashboard</h1>
          <div class="subtitle">Vista branded Sorti: KPI (range selezionabile), stato cestini, grafici CO₂ e breakdown per materiale.</div>
        </div>
      </div>
      <div class="pill"><span class="dot"></span>Live</div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
          <h2 style="margin:0;">KPI</h2>
          <div style="display:flex; align-items:center; gap:10px;">
            <div style="color:var(--muted); font-size:13px; font-weight:700;">Range:</div>
            <select id="rangeSel" style="width:160px;">
              <option value="7">7 giorni</option>
              <option value="30" selected>30 giorni</option>
              <option value="90">90 giorni</option>
            </select>
          </div>
        </div>

        <div class="kpiRow" style="margin-top:12px;">
          <div class="kpi">
            <div class="label">Peso raccolto (range)</div>
            <div id="kpiRangeW" class="value">—</div>
            <div class="hint">Somma dal report giornaliero</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ risparmiata (range)</div>
            <div id="kpiRangeC" class="value">—</div>
            <div class="hint">Somma dal report giornaliero</div>
          </div>
          <div class="kpi">
            <div class="label">Peso raccolto (totale)</div>
            <div id="kpiTotalW" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ risparmiata (totale)</div>
            <div id="kpiTotalC" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
        </div>

        <div class="row2">
          <div class="chip">Ultimo aggiornamento: <b id="lastUpdate">—</b></div>
          <div class="chip">Cestini: <b id="binsCount">—</b></div>
        </div>
      </div>

      <div class="card">
        <h2>Azioni protette (API Key)</h2>
        <input id="apiKeyInput" placeholder="Incolla la tua X-API-Key (salvata nel browser)" />
        <div class="actionsGrid">
          <button class="btn btnPrimary" onclick="saveKey()">Salva API Key</button>
          <button class="btn" onclick="clearKey()">Rimuovi</button>
          <button class="btn" onclick="downloadEventsCSV()">Scarica eventi CSV</button>
          <button class="btn" onclick="downloadDailyCSV()">Scarica CSV</button>
        </div>

        <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
          <div style="color:var(--muted); font-size:13px; width:160px;">Export giornaliero (giorni):</div>
          <input id="dailyDays" value="30" style="width:120px;">
        </div>

        <div class="help">
          I pulsanti “Segna svuotato” e gli export richiedono la chiave.
          La dashboard e i grafici restano consultabili senza.
        </div>
      </div>
    </div>

    <h3>Cestini</h3>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Bin</th>
            <th>Peso</th>
            <th>Capacità</th>
            <th>Riempimento</th>
            <th>Ultimo update</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="binsBody"></tbody>
      </table>
    </div>

    <h3>Insight</h3>
    <div class="insights">
      <div class="card">
        <h2>Andamento CO₂ (range)</h2>
        <div class="canvasWrap"><canvas id="lineChart"></canvas></div>
      </div>
      <div class="card">
        <h2>Breakdown materiali (storico totale)</h2>
        <div class="canvasWrap"><canvas id="pieChart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // ---------------------------
    // API key storage
    // ---------------------------
    const KEY_LS = "sorti_api_key";

    function getKey(){
      return localStorage.getItem(KEY_LS) || "";
    }
    function saveKey(){
      const v = document.getElementById("apiKeyInput").value.trim();
      if(!v){ alert("Inserisci una chiave."); return; }
      localStorage.setItem(KEY_LS, v);
      alert("API Key salvata ✅");
    }
    function clearKey(){
      localStorage.removeItem(KEY_LS);
      document.getElementById("apiKeyInput").value = "";
      alert("API Key rimossa.");
    }

    async function fetchJSON(url, opts={}){
      const res = await fetch(url, opts);
      if(!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    async function fetchWithKey(url, opts={}){
      const k = getKey();
      const headers = new Headers(opts.headers || {});
      if(k) headers.set("X-API-Key", k);
      const res = await fetch(url, {...opts, headers});
      if(!res.ok) throw new Error(await res.text());
      return res;
    }

    // ---------------------------
    // Formatting
    // ---------------------------
    function round(n){ return Math.round(Number(n || 0)); }
    function fmtG(n){ return `${round(n)} g`; }

    function badgeForFill(fill){
      if(fill >= 85) return `<span class="badge bBad">PIENO</span>`;
      if(fill >= 60) return `<span class="badge bWarn">QUASI PIENO</span>`;
      return `<span class="badge bOk">OK</span>`;
    }

    // ---------------------------
    // Charts
    // ---------------------------
    let lineChart, pieChart;

    function ensureCharts(){
      if(!lineChart){
        lineChart = new Chart(document.getElementById("lineChart"),{
          type:"line",
          data:{labels:[], datasets:[{
            label:"CO₂ risparmiata (g)",
            data:[],
            tension:.35,
            borderWidth:2,
            pointRadius:2
          }]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{labels:{color:"rgba(255,255,255,.75)"}}},
            scales:{
              x:{ticks:{color:"rgba(255,255,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}},
              y:{ticks:{color:"rgba(255,255,255,.55)"}, grid:{color:"rgba(255,255,255,.06)"}}
            }
          }
        });
      }

      if(!pieChart){
        pieChart = new Chart(document.getElementById("pieChart"),{
          type:"doughnut",
          data:{labels:[], datasets:[{
            data:[],
            // colori VISIBILI (evita torta nera)
            backgroundColor:[
              "rgba(41,211,145,.85)",
              "rgba(26,166,255,.85)",
              "rgba(255,204,102,.85)",
              "rgba(255,90,107,.85)",
              "rgba(180,140,255,.85)",
              "rgba(120,220,255,.85)"
            ],
            borderColor:"rgba(255,255,255,.14)",
            borderWidth:1
          }]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{labels:{color:"rgba(255,255,255,.75)"}}}
          }
        });
      }
    }

    function updateLine(daily){
      const labels = daily.map(x=>x.day);
      const data = daily.map(x=>Number(x.total_co2_saved_g || 0));
      lineChart.data.labels = labels;
      lineChart.data.datasets[0].data = data;
      lineChart.update();
    }

    function updatePie(byMat){
      const labels = byMat.map(x=>x.material);
      const data = byMat.map(x=>Number(x.weight_g || 0));
      pieChart.data.labels = labels;
      pieChart.data.datasets[0].data = data;
      pieChart.update();
    }

    // ---------------------------
    // CSV downloads (con header X-API-Key)
    // ---------------------------
    async function downloadBlob(url, filename){
      const res = await fetchWithKey(url);
      const blob = await res.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    async function downloadEventsCSV(){
      try{
        await downloadBlob("/api/export/events.csv", "events.csv");
      }catch(e){
        alert("Errore CSV (eventi): " + e.message + "\nHai salvato la API Key?");
      }
    }

    async function downloadDailyCSV(){
      const days = parseInt(document.getElementById("dailyDays").value || "30", 10);
      const safe = Math.max(1, Math.min(days, 365));
      try{
        await downloadBlob(`/api/export/daily.csv?days=${safe}`, `daily_${safe}d.csv`);
      }catch(e){
        alert("Errore CSV (daily): " + e.message + "\nHai salvato la API Key?");
      }
    }

    // ---------------------------
    // Actions
    // ---------------------------
    async function emptyBin(binId){
      try{
        await fetchWithKey(`/api/bins/${binId}/empty`, {method:"POST"});
        await refresh();
      }catch(e){
        alert("Errore svuotamento: " + e.message + "\nHai salvato la API Key?");
      }
    }

    // ---------------------------
    // Refresh
    // ---------------------------
    async function refresh(){
      ensureCharts();

      const rangeDays = parseInt(document.getElementById("rangeSel").value, 10);

      const totals = await fetchJSON("/api/stats/total");
      document.getElementById("kpiTotalW").textContent = fmtG(totals.total_weight_g);
      document.getElementById("kpiTotalC").textContent = fmtG(totals.total_co2_saved_g);

      const daily = await fetchJSON(`/api/stats/daily?days=${rangeDays}`);
      const sumW = daily.reduce((a,x)=>a+Number(x.total_weight_g||0),0);
      const sumC = daily.reduce((a,x)=>a+Number(x.total_co2_saved_g||0),0);
      document.getElementById("kpiRangeW").textContent = fmtG(sumW);
      document.getElementById("kpiRangeC").textContent = fmtG(sumC);

      updateLine(daily);

      const byMat = await fetchJSON("/api/stats/by_material");
      updatePie(byMat);

      const bins = await fetchJSON("/api/bins");
      document.getElementById("binsCount").textContent = bins.length;

      let lastSeen = "-";
      for(const b of bins){
        if(b.last_seen && (lastSeen==="-" || b.last_seen > lastSeen)) lastSeen = b.last_seen;
      }
      document.getElementById("lastUpdate").textContent = lastSeen || "-";

      const body = document.getElementById("binsBody");
      body.innerHTML = "";

      for(const b of bins){
        const fill = Number(b.fill_percent || 0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${b.bin_id}</b></td>
          <td>${round(b.current_weight_g)} g</td>
          <td>${round(b.capacity_g)} g</td>
          <td>
            <b>${round(fill)}%</b>
            ${badgeForFill(fill)}
            <span class="bar"><i style="width:${Math.max(0,Math.min(100,fill))}%;"></i></span>
          </td>
          <td style="color:rgba(255,255,255,.6)">${b.last_seen ?? "-"}</td>
          <td><button class="btn" onclick="emptyBin('${b.bin_id}')">Segna svuotato</button></td>
        `;
        body.appendChild(tr);
      }
    }

    // init
    document.getElementById("apiKeyInput").value = getKey();
    document.getElementById("rangeSel").addEventListener("change", refresh);

    refresh();
    setInterval(refresh, 5000);

    // ---------------------------
    // PWA: register SW (scope root)
    // ---------------------------
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js").catch(console.error);
    }
  </script>
</body>
</html>







