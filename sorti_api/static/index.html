<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorti SmartBin Dashboard</title>

  <!-- PWA icons (se li hai già in static/) -->
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
  <link rel="apple-touch-icon" href="/static/icon-192.png">

  <style>
    :root{
      --bg0:#071522;
      --bg1:#0b1f33;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.52);
      --good:#36d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --accent:#43cea2;
      --accent2:#185a9d;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 10% -10%, rgba(67,206,162,.35), transparent 55%),
        radial-gradient(900px 520px at 110% -5%, rgba(24,90,157,.35), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{ max-width: 1200px; margin: 28px auto; padding: 0 18px 42px; }

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom: 18px;
    }
    .brand{ display:flex; align-items:center; gap:14px; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(67,206,162,1), rgba(24,90,157,1));
      box-shadow: 0 10px 30px rgba(67,206,162,.25);
      flex:0 0 auto;
    }
    h1{ font-size: 28px; margin:0; line-height:1.15; }
    .sub{ color:var(--muted); margin-top:2px; font-size:14px; }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
    }
    .dot{ width:10px; height:10px; border-radius:99px; background: var(--good); box-shadow: 0 0 0 5px rgba(54,211,153,.18); }
    .pill span{ color:var(--muted); font-size:13px; }

    .grid2{ display:grid; grid-template-columns: 2fr 1.05fr; gap:16px; margin-top: 14px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns: 1fr; } }

    .panel{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      backdrop-filter: blur(10px);
    }
    .panelTitle{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom: 12px;
    }
    .panelTitle h2{ margin:0; font-size:16px; letter-spacing:.2px; color: rgba(255,255,255,.90); }
    .muted{ color:var(--muted); }

    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .kpis{ grid-template-columns: repeat(2, minmax(180px, 1fr)); } }
    @media (max-width: 520px){ .kpis{ grid-template-columns: 1fr; } }

    .kpi{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 14px 14px 12px;
      min-height: 88px;
    }
    .kpi .label{ color: var(--muted); font-size: 13px; }
    .kpi .value{ font-size: 22px; font-weight: 800; margin-top: 8px; }
    .kpi .hint{ margin-top: 6px; color: var(--muted2); font-size: 12px; }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .chip{
      padding: 8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      color: var(--muted);
      font-size: 13px;
    }

    select, input{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      color: var(--text);
      padding: 10px 12px;
      outline: none;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    .btn{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease;
      font-weight: 700;
    }
    .btn:hover{ background: rgba(255,255,255,.09); }
    .btn:active{ transform: translateY(1px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(67,206,162,.95), rgba(24,90,157,.95));
      border: 1px solid rgba(255,255,255,.12);
    }
    .btnPrimary:hover{ filter: brightness(1.03); }

    .fieldRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .fieldRow .grow{ flex: 1 1 240px; }

    h3{
      margin: 20px 0 10px;
      font-size: 20px;
    }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: var(--radius);
      background: rgba(255,255,255,.05);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    thead th{
      text-align:left;
      padding: 14px 14px;
      color: rgba(255,255,255,.72);
      font-weight: 800;
      font-size: 13px;
      background: rgba(0,0,0,.12);
    }
    tbody td{
      padding: 14px 14px;
      border-top: 1px solid rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      vertical-align: middle;
    }

    .binId{ font-weight: 900; letter-spacing:.2px; }
    .statusBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      font-weight: 800;
    }
    .statusBadge.ok{ color: rgba(255,255,255,.92); }
    .statusBadge.warn{ color: rgba(255,255,255,.92); }
    .statusBadge.bad{ color: rgba(255,255,255,.92); }
    .statusBadge .sDot{ width:9px; height:9px; border-radius:99px; }
    .statusBadge.ok .sDot{ background: var(--good); }
    .statusBadge.warn .sDot{ background: var(--warn); }
    .statusBadge.bad .sDot{ background: var(--bad); }

    .barWrap{
      width: 240px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
      margin-top: 8px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(67,206,162,1), rgba(24,90,157,1));
      border-radius: 999px;
      transition: width .35s ease;
    }

    .insights{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 14px;
    }
    @media (max-width: 980px){ .insights{ grid-template-columns: 1fr; } }

    .chartBox{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      min-height: 360px;
      backdrop-filter: blur(10px);
    }
    .chartTitle{
      margin: 0 0 8px;
      font-size: 16px;
      font-weight: 900;
      color: rgba(255,255,255,.90);
    }

    .error{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(251,113,133,.35);
      background: rgba(251,113,133,.12);
      color: rgba(255,255,255,.9);
      display:none;
      font-size: 13px;
      white-space: pre-wrap;
    }
  </style>

  <!-- Chart.js (HTTPS, così su Render non viene bloccato) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Sorti SmartBin Dashboard</h1>
          <div class="sub">KPI (range selezionabile), stato cestini, grafici CO₂ e breakdown per materiale.</div>
        </div>
      </div>
      <div class="pill">
        <div class="dot"></div>
        <span>Live</span>
      </div>
    </div>

    <div class="grid2">
      <div class="panel">
        <div class="panelTitle">
          <h2>KPI</h2>
          <div>
            <label class="muted" style="font-size:13px;margin-right:8px;">Range:</label>
            <select id="rangeSelect">
              <option value="7">7 giorni</option>
              <option value="30" selected>30 giorni</option>
              <option value="90">90 giorni</option>
              <option value="365">365 giorni</option>
            </select>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">Peso raccolto (range)</div>
            <div id="kpiRangeWeight" class="value">—</div>
            <div class="hint">Somma dal report giornaliero</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ risparmiata (range)</div>
            <div id="kpiRangeCO2" class="value">—</div>
            <div class="hint">Somma dal report giornaliero</div>
          </div>
          <div class="kpi">
            <div class="label">Peso raccolto (totale)</div>
            <div id="kpiTotalWeight" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ risparmiata (totale)</div>
            <div id="kpiTotalCO2" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
        </div>

        <div class="chips">
          <div class="chip">Ultimo aggiornamento: <span id="lastUpdate">—</span></div>
          <div class="chip">Cestini: <span id="binsCount">—</span></div>
          <div class="chip">Chart.js: <span id="chartStatus">—</span></div>
        </div>

        <div id="errBox" class="error"></div>
      </div>

      <div class="panel">
        <div class="panelTitle">
          <h2>Azioni protette (API Key)</h2>
        </div>

        <div class="fieldRow">
          <input id="apiKeyInput" class="grow" placeholder="Incolla la tua X-API-Key (salvata nel browser)" />
          <button class="btn btnPrimary" id="saveKeyBtn">Salva API Key</button>
          <button class="btn" id="removeKeyBtn">Rimuovi</button>
        </div>

        <div class="fieldRow" style="margin-top:12px;">
          <button class="btn" id="dlEventsBtn">Scarica eventi CSV</button>
        </div>

        <div class="fieldRow" style="margin-top:12px; align-items:center;">
          <span class="muted" style="font-size:13px;">Export giornaliero (giorni):</span>
          <input id="dailyDays" type="number" min="1" max="365" value="30" style="width:120px;">
          <button class="btn" id="dlDailyBtn">Scarica CSV</button>
        </div>

        <p class="muted" style="margin-top:14px; font-size:13px;">
          I pulsanti “Segna svuotato” e gli export richiedono la chiave.
          La dashboard e i grafici restano consultabili.
        </p>
      </div>
    </div>

    <h3>Cestini</h3>
    <table>
      <thead>
        <tr>
          <th>Bin</th>
          <th>Peso</th>
          <th>Capacità</th>
          <th>Riempimento</th>
          <th>Ultimo update</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody id="binsBody"></tbody>
    </table>

    <h3>Insight</h3>
    <div class="insights">
      <div class="chartBox">
        <div class="chartTitle">Andamento CO₂ (range)</div>
        <canvas id="co2Line"></canvas>
      </div>
      <div class="chartBox">
        <div class="chartTitle">Breakdown materiali (storico totale)</div>
        <canvas id="matPie"></canvas>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Helpers robusti (Postgres/SQLite)
    // -----------------------------
    const errBox = document.getElementById("errBox");

    function showErr(msg){
      errBox.style.display = "block";
      errBox.textContent = msg;
    }
    function clearErr(){
      errBox.style.display = "none";
      errBox.textContent = "";
    }

    function toNum(v, fallback=0){
      // gestisce number, string, Decimal->string
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }

    function fmtWeight(g){
      const n = toNum(g);
      if (n >= 1000) return (n/1000).toFixed(n >= 10000 ? 0 : 1) + " kg";
      return Math.round(n) + " g";
    }

    function fmtCO2(g){
      const n = toNum(g);
      if (n >= 1000) return (n/1000).toFixed(n >= 10000 ? 0 : 1) + " kg";
      return Math.round(n) + " g";
    }

    function badgeForFill(fill){
      const f = toNum(fill);
      if (f >= 85) return {cls:"bad", label:"PIENO"};
      if (f >= 60) return {cls:"warn", label:"QUASI PIENO"};
      return {cls:"ok", label:"OK"};
    }

    // -----------------------------
    // API Key storage
    // -----------------------------
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const removeKeyBtn = document.getElementById("removeKeyBtn");

    const KEY_LS = "SORTI_API_KEY";
    apiKeyInput.value = localStorage.getItem(KEY_LS) || "";

    saveKeyBtn.onclick = () => {
      localStorage.setItem(KEY_LS, apiKeyInput.value.trim());
      alert("API Key salvata ✅");
    };
    removeKeyBtn.onclick = () => {
      localStorage.removeItem(KEY_LS);
      apiKeyInput.value = "";
      alert("API Key rimossa ✅");
    };

    function getApiKey(){
      return (localStorage.getItem(KEY_LS) || "").trim();
    }

    // -----------------------------
    // Fetch
    // -----------------------------
    async function fetchJSON(url, opts){
      const res = await fetch(url, opts);
      if (!res.ok){
        const t = await res.text();
        throw new Error(`${url}\nHTTP ${res.status}\n${t}`);
      }
      return await res.json();
    }

    // Download helper
    async function downloadFile(url, filename, opts){
      const res = await fetch(url, opts);
      if (!res.ok){
        const t = await res.text();
        throw new Error(`${url}\nHTTP ${res.status}\n${t}`);
      }
      const blob = await res.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    // -----------------------------
    // Charts init
    // -----------------------------
    const chartStatus = document.getElementById("chartStatus");
    const hasChart = typeof Chart !== "undefined";
    chartStatus.textContent = hasChart ? "OK" : "NON CARICATO";

    let co2Chart = null;
    let pieChart = null;

    function ensureCharts(){
      if (!hasChart) return;

      const ctxLine = document.getElementById("co2Line");
      const ctxPie = document.getElementById("matPie");

      if (!co2Chart){
        co2Chart = new Chart(ctxLine, {
          type: "line",
          data: { labels: [], datasets: [{ label:"CO₂ (g)", data: [], tension: 0.35 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: "rgba(255,255,255,.75)" } } },
            scales: {
              x: { ticks: { color: "rgba(255,255,255,.65)" }, grid: { color: "rgba(255,255,255,.06)" } },
              y: { ticks: { color: "rgba(255,255,255,.65)" }, grid: { color: "rgba(255,255,255,.06)" } }
            }
          }
        });
      }

      if (!pieChart){
        pieChart = new Chart(ctxPie, {
          type: "doughnut",
          data: { labels: [], datasets: [{ label:"CO₂ (g)", data: [] }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: "rgba(255,255,255,.75)" } }
            }
          }
        });
      }
    }

    // -----------------------------
    // UI update
    // -----------------------------
    const rangeSelect = document.getElementById("rangeSelect");
    const kpiRangeWeight = document.getElementById("kpiRangeWeight");
    const kpiRangeCO2 = document.getElementById("kpiRangeCO2");
    const kpiTotalWeight = document.getElementById("kpiTotalWeight");
    const kpiTotalCO2 = document.getElementById("kpiTotalCO2");
    const lastUpdate = document.getElementById("lastUpdate");
    const binsCount = document.getElementById("binsCount");
    const binsBody = document.getElementById("binsBody");

    function sumDaily(daily){
      // robust: accetta weight_g o total_weight_g (idem co2)
      let w = 0, c = 0;
      for (const r of daily){
        w += toNum(r.weight_g ?? r.total_weight_g ?? 0);
        c += toNum(r.co2_saved_g ?? r.total_co2_saved_g ?? 0);
      }
      return { w, c };
    }

    function updateBinsTable(bins){
      binsBody.innerHTML = "";
      for (const b of bins){
        const capacity = toNum(b.capacity_g);
        const current = toNum(b.current_weight_g);

        // robust fill percent:
        let fill = (b.fill_percent !== undefined && b.fill_percent !== null)
          ? toNum(b.fill_percent)
          : (capacity > 0 ? (current / capacity) * 100 : 0);

        fill = Math.max(0, Math.min(fill, 100));

        const st = badgeForFill(fill);

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="binId">${b.bin_id}</td>
          <td>${fmtWeight(current)}</td>
          <td>${fmtWeight(capacity)}</td>
          <td>
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
              <div style="font-weight:900;">${Math.round(fill)}%</div>
              <span class="statusBadge ${st.cls}">
                <span class="sDot"></span>${st.label}
              </span>
            </div>
            <div class="barWrap"><div class="bar" style="width:${fill.toFixed(2)}%"></div></div>
          </td>
          <td class="muted">${b.last_seen ?? "-"}</td>
          <td>
            <button class="btn" onclick="emptyBin('${b.bin_id.replace(/'/g,"\\'")}')">Segna svuotato</button>
          </td>
        `;
        binsBody.appendChild(tr);
      }
    }

    async function refresh(){
      clearErr();
      ensureCharts();

      const days = parseInt(rangeSelect.value, 10);

      // totals (storico)
      const totals = await fetchJSON("/api/stats/total");
      const totalW = toNum(totals.total_weight_g ?? totals.weight_g ?? 0);
      const totalC = toNum(totals.total_co2_saved_g ?? totals.co2_saved_g ?? 0);
      kpiTotalWeight.textContent = fmtWeight(totalW);
      kpiTotalCO2.textContent = fmtCO2(totalC);

      // daily (range)
      const daily = await fetchJSON(`/api/stats/daily?days=${days}`);
      const s = sumDaily(daily);
      kpiRangeWeight.textContent = fmtWeight(s.w);
      kpiRangeCO2.textContent = fmtCO2(s.c);

      // bins
      const bins = await fetchJSON("/api/bins");
      binsCount.textContent = String(bins.length);
      updateBinsTable(bins);

      // charts
      if (hasChart && co2Chart){
        const labels = daily.map(r => (r.day ?? r.date ?? "").toString());
        const values = daily.map(r => toNum(r.co2_saved_g ?? r.total_co2_saved_g ?? 0));
        co2Chart.data.labels = labels;
        co2Chart.data.datasets[0].data = values;
        co2Chart.update();
      }

      const byMat = await fetchJSON("/api/stats/by_material");
      if (hasChart && pieChart){
        pieChart.data.labels = byMat.map(r => (r.material ?? "—").toString());
        pieChart.data.datasets[0].data = byMat.map(r => toNum(r.co2_saved_g ?? r.total_co2_saved_g ?? 0));
        pieChart.update();
      }

      lastUpdate.textContent = new Date().toLocaleString();
    }

    // Protected actions
    window.emptyBin = async function(binId){
      const key = getApiKey();
      if (!key) return alert("Inserisci e salva prima la tua API Key.");
      await fetchJSON(`/api/bins/${encodeURIComponent(binId)}/empty`, {
        method: "POST",
        headers: { "X-API-Key": key }
      });
      await refresh();
    };

    const dlEventsBtn = document.getElementById("dlEventsBtn");
    const dlDailyBtn = document.getElementById("dlDailyBtn");
    const dailyDays = document.getElementById("dailyDays");

    dlEventsBtn.onclick = async () => {
      try{
        const key = getApiKey();
        if (!key) return alert("Inserisci e salva prima la tua API Key.");
        await downloadFile("/api/export/events.csv", "sorti_events.csv", {
          headers: { "X-API-Key": key }
        });
      }catch(e){ showErr(String(e)); }
    };

    dlDailyBtn.onclick = async () => {
      try{
        const key = getApiKey();
        if (!key) return alert("Inserisci e salva prima la tua API Key.");
        const d = Math.max(1, Math.min(parseInt(dailyDays.value || "30", 10), 365));
        await downloadFile(`/api/export/daily.csv?days=${d}`, `sorti_daily_${d}d.csv`, {
          headers: { "X-API-Key": key }
        });
      }catch(e){ showErr(String(e)); }
    };

    // loop
    rangeSelect.addEventListener("change", () => refresh().catch(e => showErr(String(e))));

    refresh().catch(e => showErr(String(e)));
    setInterval(() => refresh().catch(e => showErr(String(e))), 4500);
  </script>
</body>
</html>









