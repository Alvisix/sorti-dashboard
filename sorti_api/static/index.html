<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorti SmartBin Dashboard</title>

  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
  <link rel="apple-touch-icon" href="/static/icon-192.png">

  <style>
    :root{
      --bg0:#07111f; --bg1:#0b1a2f;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --good:#42d392; --warn:#f7c948; --bad:#ff5d5d;
      --brand1:#43cea2; --brand2:#185a9d;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(67,206,162,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 35%, rgba(24,90,157,.25), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:26px 18px 46px}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px; flex-wrap:wrap;
      padding:18px;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(67,206,162,.12), rgba(24,90,157,.10));
      border-radius: var(--r);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:14px}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
    }
    h1{margin:0; font-size:22px; line-height:1.2}
    .sub{margin:2px 0 0; color:var(--muted); font-size:13.5px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(0,0,0,.20);
      color:var(--muted);
      font-size:13px;
    }
    .dot{width:10px; height:10px; border-radius:999px; background: var(--good); box-shadow: 0 0 0 5px rgba(66,211,146,.14);}

    .grid{
      display:grid;
      grid-template-columns: 2fr 1.1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .cardHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .title{font-weight:800; letter-spacing:.2px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .kpi{
      flex: 1 1 220px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border-radius: 16px;
      padding:14px;
      min-width: 220px;
    }
    .kpi .label{color:var(--muted); font-size:13px}
    .kpi .value{font-size:22px; font-weight:900; margin-top:6px}
    .kpi .hint{color:var(--muted2); font-size:12.5px; margin-top:6px}
    .muted{color:var(--muted)}
    .small{font-size:12.5px}
    .sep{height:1px; background: rgba(255,255,255,.08); margin:12px 0}

    select, input{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--txt);
      outline:none;
    }
    input::placeholder{color: rgba(255,255,255,.45)}
    button{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      color: var(--txt);
      cursor:pointer;
      transition: .15s transform, .15s background;
      font-weight: 750;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: translateY(1px)}
    .btnPrimary{
      background: linear-gradient(135deg, rgba(67,206,162,.9), rgba(24,90,157,.9));
      border: 1px solid rgba(255,255,255,.18);
    }
    .btnDanger{
      background: rgba(255,93,93,.14);
      border:1px solid rgba(255,93,93,.40);
    }

    .errBox{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,93,93,.45);
      background: rgba(255,93,93,.12);
      color: rgba(255,255,255,.92);
      font-size:13px;
      white-space:pre-wrap;
    }

    /* Table */
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    thead th{
      text-align:left;
      color: var(--muted);
      font-weight:800;
      font-size:13px;
      padding: 0 10px 8px;
    }
    tbody td{
      padding: 14px 10px;
      border-top:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.05);
    }
    tbody tr td:first-child{
      border-left:1px solid rgba(255,255,255,.06);
      border-top-left-radius: 16px;
      border-bottom-left-radius: 16px;
      font-weight:900;
      letter-spacing:.2px;
    }
    tbody tr td:last-child{
      border-right:1px solid rgba(255,255,255,.06);
      border-top-right-radius: 16px;
      border-bottom-right-radius: 16px;
      text-align:right;
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      font-size:12.5px;
      font-weight:900;
      margin-left:10px;
    }
    .bOK{background: rgba(66,211,146,.16); border-color: rgba(66,211,146,.35)}
    .bWARN{background: rgba(247,201,72,.16); border-color: rgba(247,201,72,.35)}
    .bBAD{background: rgba(255,93,93,.16); border-color: rgba(255,93,93,.35)}

    .bar{
      height: 12px;
      width: 240px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      display:inline-block;
      vertical-align: middle;
      margin-left: 12px;
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(67,206,162,.95), rgba(24,90,157,.95));
      transition: width .25s ease;
    }

    .insights{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 980px){ .insights{grid-template-columns:1fr} }

    .canvasWrap{height: 280px; position: relative;}
    .emptyState{
      padding: 14px;
      color: var(--muted);
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      margin-top: 10px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Sorti SmartBin Dashboard</h1>
          <div class="sub">Ora con ingest key (Raspberry-ready) + simulatore eventi integrato.</div>
        </div>
      </div>
      <div class="pill"><span class="dot"></span><span id="liveText">Live</span></div>
    </div>

    <div class="grid">
      <!-- KPI -->
      <div class="card">
        <div class="cardHeader">
          <div class="title">KPI</div>
          <div class="row" style="align-items:center">
            <span class="muted small">Range:</span>
            <select id="rangeSel">
              <option value="7">7 giorni</option>
              <option value="30" selected>30 giorni</option>
              <option value="90">90 giorni</option>
              <option value="365">365 giorni</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="kpi">
            <div class="label">Peso raccolto (range)</div>
            <div id="kpiRangeWeight" class="value">—</div>
            <div class="hint">Somma dal report giornaliero</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ risparmiata (range)</div>
            <div id="kpiRangeCO2" class="value">—</div>
            <div class="hint">Somma dal report giornaliero</div>
          </div>
          <div class="kpi">
            <div class="label">Peso raccolto (totale)</div>
            <div id="kpiTotalWeight" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ risparmiata (totale)</div>
            <div id="kpiTotalCO2" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
        </div>

        <div class="sep"></div>
        <div class="row">
          <div class="pill"><span class="muted">Ultimo aggiornamento:</span> <b id="lastUpdated">—</b></div>
          <div class="pill"><span class="muted">Cestini:</span> <b id="binsCount">—</b></div>
        </div>

        <div id="errBox" class="errBox"></div>
      </div>

      <!-- Keys + Simulator -->
      <div class="card">
        <div class="cardHeader">
          <div class="title">Chiavi & Simulator</div>
          <div class="small muted">Admin ≠ Ingest</div>
        </div>

        <div class="row" style="margin-bottom:10px">
          <input id="adminKeyInput" type="password" placeholder="ADMIN key (X-API-Key)" style="flex:1 1 240px" />
          <button class="btnPrimary" id="btnSaveAdmin">Salva Admin</button>
        </div>

        <div class="row">
          <input id="ingestKeyInput" type="password" placeholder="INGEST key (X-Ingest-Key)" style="flex:1 1 240px" />
          <button class="btnPrimary" id="btnSaveIngest">Salva Ingest</button>
        </div>

        <div class="sep"></div>

        <div class="title" style="margin-bottom:8px">Simula evento (come Raspberry)</div>
        <div class="row">
          <input id="simBin" placeholder="bin_id (es: SORTI_001)" style="flex:1 1 180px" />
          <input id="simMat" placeholder="materiale (plastica/carta/...)" style="flex:1 1 180px" />
          <input id="simW" type="number" min="1" placeholder="grammi" style="width:120px" />
          <button id="btnSimEvent">Invia</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button id="btnExportEvents">Scarica eventi CSV (admin)</button>
        </div>

        <div class="row" style="margin-top:10px; align-items:center">
          <span class="muted small">Export daily (giorni):</span>
          <input id="exportDays" type="number" min="1" max="365" value="30" style="width:120px" />
          <button id="btnExportDaily">Scarica CSV (admin)</button>
        </div>

        <div class="small muted" style="margin-top:12px; line-height:1.35">
          • Il Raspberry userà <b>solo</b> la ingest key per <code>POST /api/event</code><br>
          • Tu usi admin key per svuotare/export/config capacità
        </div>
      </div>
    </div>

    <!-- Bins -->
    <div class="card" style="margin-top:16px">
      <div class="cardHeader">
        <div class="title">Cestini</div>
        <div class="small muted">/api/bins</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Bin</th>
            <th>Peso</th>
            <th>Capacità</th>
            <th>Riempimento</th>
            <th>Ultimo update</th>
            <th style="text-align:right">Azioni (admin)</th>
          </tr>
        </thead>
        <tbody id="binsBody"></tbody>
      </table>
    </div>

    <!-- Insights -->
    <div class="insights">
      <div class="card">
        <div class="cardHeader">
          <div class="title">Andamento CO₂ (range)</div>
          <div class="small muted">/api/stats/daily</div>
        </div>
        <div class="canvasWrap"><canvas id="co2Line"></canvas></div>
        <div id="lineEmpty" class="emptyState" style="display:none">Nessun dato nel range selezionato.</div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="title">Breakdown materiali (peso totale)</div>
          <div class="small muted">/api/stats/by_material</div>
        </div>
        <div class="canvasWrap"><canvas id="matPie"></canvas></div>
        <div id="pieEmpty" class="emptyState" style="display:none">Nessun dato materiali (ancora nessun evento).</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    function showError(msg){
      $("errBox").style.display = "block";
      $("errBox").textContent = msg;
      $("liveText").textContent = "Errore";
    }
    function clearError(){
      $("errBox").style.display = "none";
      $("errBox").textContent = "";
      $("liveText").textContent = "Live";
    }

    function formatWeight(g){
      const n = Number(g || 0);
      if (!isFinite(n)) return "—";
      if (n >= 1000){
        const kg = n/1000;
        const txt = (kg < 100 ? kg.toFixed(1) : Math.round(kg).toString());
        return txt + " kg";
      }
      return Math.round(n) + " g";
    }
    const formatCO2 = formatWeight;

    function isoToNice(s){
      if (!s) return "—";
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      return d.toLocaleString();
    }

    function fillBadge(fill){
      const f = Number(fill || 0);
      if (f >= 85) return `<span class="badge bBAD">PIENO</span>`;
      if (f >= 60) return `<span class="badge bWARN">QUASI PIENO</span>`;
      return `<span class="badge bOK">OK</span>`;
    }

    // localStorage keys
    const LS_ADMIN = "sorti_admin_key";
    const LS_INGEST = "sorti_ingest_key";

    function adminKey(){ return localStorage.getItem(LS_ADMIN) || ""; }
    function ingestKey(){ return localStorage.getItem(LS_INGEST) || ""; }

    $("btnSaveAdmin").onclick = () => {
      const v = $("adminKeyInput").value.trim();
      if (!v) return alert("Incolla la ADMIN key.");
      localStorage.setItem(LS_ADMIN, v);
      $("adminKeyInput").value = "";
      alert("Admin key salvata ✅");
    };

    $("btnSaveIngest").onclick = () => {
      const v = $("ingestKeyInput").value.trim();
      if (!v) return alert("Incolla la INGEST key.");
      localStorage.setItem(LS_INGEST, v);
      $("ingestKeyInput").value = "";
      alert("Ingest key salvata ✅");
    };

    async function fetchJSON(url, opts={}){
      const res = await fetch(url, opts);
      const text = await res.text();
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}\n${text}`);
      try { return JSON.parse(text); }
      catch { throw new Error(`Risposta non-JSON da ${url}\n${text}`); }
    }

    async function downloadFile(url, filename, headers){
      const res = await fetch(url, { headers });
      if (!res.ok){
        const t = await res.text();
        throw new Error(`${res.status} ${res.statusText}\n${t}`);
      }
      const blob = await res.blob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    // Charts
    Chart.defaults.color = "rgba(255,255,255,.82)";
    Chart.defaults.borderColor = "rgba(255,255,255,.10)";
    Chart.defaults.font.family = "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif";

    const lineChart = new Chart($("co2Line").getContext("2d"), {
      type:"line",
      data:{labels:[], datasets:[{
        label:"CO₂ (g)",
        data:[],
        borderWidth:2,
        tension:.25,
        pointRadius:3,
        pointHoverRadius:5
      }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false} },
        scales:{
          x:{ grid:{display:false} },
          y:{ ticks:{ callback:(v)=>formatCO2(v) } }
        }
      }
    });

    const pieChart = new Chart($("matPie").getContext("2d"), {
      type:"doughnut",
      data:{labels:[], datasets:[{
        data:[],
        backgroundColor:[
          "rgba(67,206,162,.90)",
          "rgba(24,90,157,.90)",
          "rgba(247,201,72,.90)",
          "rgba(255,93,93,.90)",
          "rgba(164,121,255,.90)",
          "rgba(255,140,73,.90)",
          "rgba(96,215,255,.90)",
          "rgba(160,255,160,.90)"
        ],
        borderColor:"rgba(255,255,255,.18)",
        borderWidth:1.5
      }]},
      options:{
        responsive:true, maintainAspectRatio:false,
        cutout:"62%",
        plugins:{ legend:{ position:"top", labels:{ boxWidth:14 } } }
      }
    });

    async function refresh(){
      clearError();
      const days = Number($("rangeSel").value || 30);

      // totals
      const totals = await fetchJSON("/api/stats/total");
      $("kpiTotalWeight").textContent = formatWeight(totals.total_weight_g);
      $("kpiTotalCO2").textContent = formatCO2(totals.total_co2_saved_g);

      // bins
      const bins = await fetchJSON("/api/bins");
      $("binsCount").textContent = bins.length.toString();

      const body = $("binsBody");
      body.innerHTML = "";

      for (const b of bins){
        const fill = Number(b.fill_percent || 0);
        const wTxt = formatWeight(b.current_weight_g);
        const cTxt = formatWeight(b.capacity_g);
        const barWidth = Math.max(0, Math.min(100, fill));

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${b.bin_id}</td>
          <td>${wTxt}</td>
          <td>${cTxt}</td>
          <td>
            <b>${Math.round(fill)}%</b>
            ${fillBadge(fill)}
            <span class="bar"><div style="width:${barWidth}%"></div></span>
          </td>
          <td class="muted">${isoToNice(b.last_seen)}</td>
          <td>
            <button class="btnDanger" onclick="emptyBin('${b.bin_id}')">Segna svuotato</button>
          </td>
        `;
        body.appendChild(tr);
      }

      // daily
      const daily = await fetchJSON(`/api/stats/daily?days=${days}`);
      const rangeW = daily.reduce((s,r)=>s+Number(r.weight_g||0), 0);
      const rangeC = daily.reduce((s,r)=>s+Number(r.co2_saved_g||0), 0);

      $("kpiRangeWeight").textContent = formatWeight(rangeW);
      $("kpiRangeCO2").textContent = formatCO2(rangeC);

      const hasLineData = daily.some(r => Number(r.co2_saved_g||0) > 0);
      $("lineEmpty").style.display = hasLineData ? "none" : "block";

      lineChart.data.labels = daily.map(r=>r.day);
      lineChart.data.datasets[0].data = daily.map(r=>Number(r.co2_saved_g||0));
      lineChart.update();

      // by material
      const mats = await fetchJSON("/api/stats/by_material");
      const hasPieData = mats.some(r => Number(r.weight_g||0) > 0);
      $("pieEmpty").style.display = hasPieData ? "none" : "block";

      pieChart.data.labels = mats.map(r=>r.material);
      pieChart.data.datasets[0].data = mats.map(r=>Number(r.weight_g||0));
      pieChart.update();

      $("lastUpdated").textContent = new Date().toLocaleString();
    }

    // Protected actions
    async function emptyBin(binId){
      try{
        if (!adminKey()) return alert("Manca Admin key (X-API-Key).");
        const ok = confirm(`Confermi svuotamento ${binId}?\n(Azzera solo il peso bin, non cancella eventi)`);
        if (!ok) return;

        await fetchJSON(`/api/bins/${encodeURIComponent(binId)}/empty`, {
          method:"POST",
          headers: { "X-API-Key": adminKey() }
        });
        await refresh();
      }catch(e){
        alert("Errore svuotamento:\n\n" + (e?.message || String(e)));
      }
    }
    window.emptyBin = emptyBin;

    // Simulator event
    $("btnSimEvent").onclick = async () => {
      try{
        if (!ingestKey()) return alert("Manca Ingest key (X-Ingest-Key).");
        const bin = $("simBin").value.trim();
        const mat = $("simMat").value.trim();
        const w = Number($("simW").value || 0);

        if (!bin || !mat || !w) return alert("Compila bin_id, materiale e grammi.");

        await fetchJSON("/api/event", {
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "X-Ingest-Key": ingestKey()
          },
          body: JSON.stringify({ bin_id: bin, material: mat, weight_g: w })
        });

        $("simW").value = "";
        await refresh();
      }catch(e){
        alert("Errore invio evento:\n\n" + (e?.message || String(e)));
      }
    };

    // Export
    $("btnExportEvents").onclick = async () => {
      try{
        if (!adminKey()) return alert("Manca Admin key.");
        await downloadFile("/api/export/events.csv", "sorti_events.csv", { "X-API-Key": adminKey() });
      }catch(e){
        alert("Errore export eventi:\n\n" + (e?.message || String(e)));
      }
    };

    $("btnExportDaily").onclick = async () => {
      try{
        if (!adminKey()) return alert("Manca Admin key.");
        const d = Math.max(1, Math.min(365, Number($("exportDays").value || 30)));
        await downloadFile(`/api/export/daily.csv?days=${d}`, `sorti_daily_${d}d.csv`, { "X-API-Key": adminKey() });
      }catch(e){
        alert("Errore export daily:\n\n" + (e?.message || String(e)));
      }
    };

    $("rangeSel").onchange = () => refresh().catch(e => showError(e?.message || String(e)));

    refresh().catch(e => showError(e?.message || String(e)));
    setInterval(() => refresh().catch(e => showError(e?.message || String(e))), 5000);
  </script>
</body>
</html>











