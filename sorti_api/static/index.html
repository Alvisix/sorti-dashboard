<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorti SmartBin Dashboard</title>

  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
  <link rel="apple-touch-icon" href="/static/icon-192.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/static/app.css?v=2">
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Sorti SmartBin</h1>
          <div class="sub">Dashboard real-time: eventi, CO₂, riempimento e alert operativi.</div>
        </div>
      </div>

      <div class="headerRight">
        <div class="pill">
          <span id="connDot" class="dot"></span>
          <span id="liveText">Live</span>
        </div>
        <div class="pill">
          <span class="muted">Aggiornato:</span>
          <b id="lastUpdated">—</b>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <div class="title">Overview</div>
          <div class="row" style="align-items:center">
            <span class="muted small">Range</span>
            <select id="rangeSel">
              <option value="7">7 giorni</option>
              <option value="30" selected>30 giorni</option>
              <option value="90">90 giorni</option>
              <option value="365">365 giorni</option>
            </select>
          </div>
        </div>

        <div class="kpiRow">
          <div class="kpi">
            <div class="label">Peso (range)</div>
            <div id="kpiRangeWeight" class="value">—</div>
            <div class="hint">Somma nel range</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ (range)</div>
            <div id="kpiRangeCO2" class="value">—</div>
            <div class="hint">Somma nel range</div>
          </div>
          <div class="kpi">
            <div class="label">Peso (totale)</div>
            <div id="kpiTotalWeight" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
          <div class="kpi">
            <div class="label">CO₂ (totale)</div>
            <div id="kpiTotalCO2" class="value">—</div>
            <div class="hint">Storico completo</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="quick">
          <div class="row" style="align-items:center">
            <span class="title">Alert</span>
            <span id="alertSummary" class="chip ok">0</span>
            <span class="muted small">Warn ≥ <b id="warnLabel">70%</b></span>
            <span class="muted small">Crit ≥ <b id="critLabel">85%</b></span>
            <span class="muted small">Cestini: <b id="binsCount">—</b></span>
          </div>
          <div class="row" style="align-items:center">
            <label class="toggle" title="Mostra solo bins in warning/critical">
              <input type="checkbox" id="onlyAlerts">
              Solo alert
            </label>
            <button class="btnGhost btnMini" id="btnEditThresholds">Soglie</button>
          </div>
        </div>

        <div id="alertsList" class="emptyState" style="display:none"></div>
        <div id="errBox" class="errBox"></div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="title">Tools</div>
          <div class="small muted">admin ≠ ingest</div>
        </div>

        <div class="row" style="margin-bottom:10px">
          <input id="adminKeyInput" type="password" placeholder="ADMIN key (X-API-Key)" style="flex:1 1 240px" />
          <button class="btnPrimary" id="btnSaveAdmin">Salva</button>
        </div>

        <div class="row">
          <input id="ingestKeyInput" type="password" placeholder="INGEST key (X-Ingest-Key)" style="flex:1 1 240px" />
          <button class="btnPrimary" id="btnSaveIngest">Salva</button>
        </div>

        <div class="sep"></div>

        <div class="title" style="margin-bottom:8px">Simula evento</div>
        <div class="row">
          <input id="simBin" placeholder="bin_id (es: SORTI_001)" style="flex:1 1 180px" />
          <input id="simMat" list="matList" placeholder="materiale (es: plastica)" style="flex:1 1 180px" />
          <datalist id="matList">
            <option value="plastica"></option>
            <option value="carta"></option>
            <option value="vetro"></option>
            <option value="metallo"></option>
            <option value="organico"></option>
          </datalist>
          <input id="simW" type="number" min="1" placeholder="g" style="width:120px" />
          <button id="btnSimEvent">Invia</button>
        </div>

        <div id="simResult" class="emptyState" style="display:none"></div>

        <div class="sep"></div>

        <div class="row">
          <button id="btnExportEvents">Export eventi CSV</button>
        </div>

        <div class="row" style="margin-top:10px; align-items:center">
          <span class="muted small">Daily:</span>
          <input id="exportDays" type="number" min="1" max="365" value="30" style="width:120px" />
          <button id="btnExportDaily">Export CSV</button>
        </div>
      </div>
    </div>

    <!-- DESKTOP TABLE -->
    <div class="card" style="margin-top:16px">
      <div class="cardHeader">
        <div class="title">Bins</div>
        <div class="small muted">tap/click su un bin per dettagli</div>
      </div>

      <div class="tableWrap onlyDesktop">
        <table>
          <thead>
            <tr>
              <th>Bin</th>
              <th>Peso</th>
              <th>Capacità</th>
              <th>Riempimento</th>
              <th>Ultimo update</th>
              <th style="text-align:right">Azioni</th>
            </tr>
          </thead>
          <tbody id="binsBody"></tbody>
        </table>
      </div>

      <!-- MOBILE CARDS -->
      <div id="binsCards" class="cardsGrid onlyMobile"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="cardHeader">
        <div class="title">Recent events (admin)</div>
        <div class="small muted">visibili solo con admin key valida</div>
      </div>

      <div id="eventsEmpty" class="emptyState" style="display:none"></div>

      <div class="tableWrap">
        <table class="eventsTable">
          <thead>
            <tr>
              <th>Quando</th>
              <th>Bin</th>
              <th>Materiale</th>
              <th>Peso</th>
              <th>CO₂</th>
              <th style="text-align:right">event_id</th>
            </tr>
          </thead>
          <tbody id="eventsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="insights">
      <div class="card">
        <div class="cardHeader">
          <div class="title">CO₂ over time</div>
          <div class="small muted">range selezionato</div>
        </div>
        <div class="canvasWrap"><canvas id="co2Line"></canvas></div>
        <div id="lineEmpty" class="emptyState" style="display:none">Nessun dato nel range selezionato.</div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div class="title">Materials breakdown</div>
          <div class="small muted">peso totale</div>
        </div>
        <div class="canvasWrap"><canvas id="matPie"></canvas></div>
        <div id="pieEmpty" class="emptyState" style="display:none">Nessun dato materiali (ancora nessun evento).</div>
      </div>
    </div>
  </div>

  <!-- Drill-down Drawer -->
  <div id="drawerOverlay" class="drawerOverlay" aria-hidden="true"></div>

  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawerTop">
      <div>
        <div class="drawerTitle" id="ddTitle">Bin —</div>
        <div class="drawerSub muted" id="ddSub">—</div>
      </div>
      <button class="btnGhost btnMini" id="btnCloseDrawer">Chiudi</button>
    </div>

    <div class="drawerBody">
      <div class="ddKpis">
        <div class="kpi kpiTight">
          <div class="label">Riempimento</div>
          <div id="ddFill" class="value">—</div>
          <div id="ddFillHint" class="hint">—</div>
        </div>
        <div class="kpi kpiTight">
          <div class="label">Peso attuale</div>
          <div id="ddWeight" class="value">—</div>
          <div class="hint">nel bin</div>
        </div>
        <div class="kpi kpiTight">
          <div class="label">Capacità</div>
          <div id="ddCap" class="value">—</div>
          <div class="hint">configurata</div>
        </div>
        <div class="kpi kpiTight">
          <div class="label">Ultimo update</div>
          <div id="ddLast" class="value">—</div>
          <div class="hint">—</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="title">Azioni</div>
        <div class="row">
          <button class="btnGhost btnMini" id="ddBtnCapacity">Capacità</button>
          <button class="btnDanger btnMini" id="ddBtnEmpty">Svuota</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="cardHeader" style="padding:0; margin:0 0 8px">
        <div class="title">CO₂ (bin) nel range</div>
        <div class="small muted"><span id="ddRangeLabel">—</span></div>
      </div>
      <div class="canvasWrap ddCanvas"><canvas id="ddLine"></canvas></div>
      <div id="ddLineEmpty" class="emptyState" style="display:none">Nessun dato nel range selezionato.</div>

      <div class="sep"></div>

      <div class="cardHeader" style="padding:0; margin:0 0 8px">
        <div class="title">Materiali (bin) nel range</div>
        <div class="small muted">peso totale</div>
      </div>
      <div class="canvasWrap ddCanvas"><canvas id="ddPie"></canvas></div>
      <div id="ddPieEmpty" class="emptyState" style="display:none">Nessun dato materiali.</div>

      <div class="sep"></div>

      <div class="cardHeader" style="padding:0; margin:0 0 8px">
        <div class="title">Ultimi eventi (bin)</div>
        <div class="small muted">richiede admin key valida</div>
      </div>
      <div id="ddEventsEmpty" class="emptyState" style="display:none"></div>
      <div class="tableWrap">
        <table class="eventsTable">
          <thead>
            <tr>
              <th>Quando</th>
              <th>Materiale</th>
              <th>Peso</th>
              <th>CO₂</th>
              <th style="text-align:right">event_id</th>
            </tr>
          </thead>
          <tbody id="ddEventsBody"></tbody>
        </table>
      </div>
    </div>
  </aside>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/static/app.js?v=2" defer></script>
</body>
</html>





























